class LuxuryChat{constructor(){this.userEmail=null,this.username=null,this.messages=[],this.isOpen=!1,this.lastMessageCount=0,this.pollingInterval=null,this.particleInterval=null,this.screenshotProtectionActive=!1,this.soundEnabled="off"!==localStorage.getItem("chat_sound"),this.notificationSound=null,window.addEventListener("beforeunload",()=>this.cleanup())}cleanup(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.particleInterval&&(clearInterval(this.particleInterval),this.particleInterval=null),this.removeScreenshotProtection()}init(e){this.userEmail=e,this.sessionStart=(new Date).toISOString(),this.generateUsername(),this.initNotificationSound(),this.createChatUI(),this.initScreenshotProtection(),this.requestPushPermission(),this.startPolling()}initNotificationSound(){this._audioCtx=null}playNotificationSound(){if(this.soundEnabled)try{this._audioCtx&&"closed"!==this._audioCtx.state||(this._audioCtx=new(window.AudioContext||window.webkitAudioContext));const e=this._audioCtx;if("suspended"===e.state)return void e.resume().then(()=>this._playChime(e));this._playChime(e)}catch(e){console.warn("Sound playback failed:",e),this._audioCtx=null}}_playChime(e){try{const t=e.currentTime,n=(n,s,i,a)=>{const o=e.createOscillator(),r=e.createGain();o.connect(r),r.connect(e.destination),o.type="sine",o.frequency.setValueAtTime(n,t+s),r.gain.setValueAtTime(0,t+s),r.gain.linearRampToValueAtTime(a,t+s+.02),r.gain.exponentialRampToValueAtTime(.001,t+s+i),o.start(t+s),o.stop(t+s+i)};n(523.25,0,.3,.15),n(659.25,.12,.35,.12),n(783.99,.22,.4,.08)}catch(e){console.warn("Chime playback failed:",e)}}toggleSound(){this.soundEnabled=!this.soundEnabled,localStorage.setItem("chat_sound",this.soundEnabled?"on":"off");const e=document.getElementById("chatSoundToggle");e&&(e.innerHTML=this.soundEnabled?"ðŸ””":"ðŸ”‡",e.title=this.soundEnabled?"Sound deaktivieren":"Sound aktivieren"),this.soundEnabled&&this.playNotificationSound()}async requestPushPermission(){if("serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window)try{const e=await navigator.serviceWorker.ready;"default"===Notification.permission?setTimeout(async()=>{try{"granted"===await Notification.requestPermission()&&await this._subscribeToPush(e)}catch(e){console.warn("Permission request failed:",e)}},3e3):"granted"===Notification.permission&&await this._subscribeToPush(e)}catch(e){console.warn("Push subscription failed:",e)}else console.warn("Push notifications not supported on this device")}async _subscribeToPush(e){try{let t=await e.pushManager.getSubscription();if(!t){const n="BImYUR7FiZgYywJNjKzSiIkDPdotF5OX5E1h023JBKk4Yr6nSnIzq6OD5PDNKLSl-UK1xxoFFY4uWWPyNAJaoGs",s=this._urlBase64ToUint8Array(n);t=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:s})}const n=this.userEmail||sessionStorage.getItem("userEmail")||localStorage.getItem("userEmail");await fetch("/api/push-subscribe",{method:"POST",headers:{"Content-Type":"application/json","x-user-email":n||""},body:JSON.stringify({subscription:t.toJSON(),userAgent:navigator.userAgent,email:n})})}catch(e){console.warn("Push subscribe error:",e)}}_urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),s=new Uint8Array(n.length);for(let e=0;e<n.length;++e)s[e]=n.charCodeAt(e);return s}initScreenshotProtection(){if(this.screenshotProtectionActive=!0,this._onKeyDown=e=>{if(this.isOpen)return"PrintScreen"===e.key||44===e.keyCode||"S"===e.key&&e.shiftKey&&(e.metaKey||e.getModifierState("OS"))?(e.preventDefault(),this.showSecurityWarning(),this.blurChat(2e3),!1):"s"===e.key&&e.ctrlKey&&e.shiftKey||"p"===e.key&&e.ctrlKey?(e.preventDefault(),this.showSecurityWarning(),!1):"I"===e.key&&e.ctrlKey&&e.shiftKey?(e.preventDefault(),!1):void 0},document.addEventListener("keydown",this._onKeyDown,!0),document.addEventListener("keyup",e=>{if("PrintScreen"===e.key&&this.isOpen)try{navigator.clipboard.writeText("Screenshot blocked by BILLIONAIRS Security")}catch(e){}},!0),this._onVisibility=()=>{if(!this.isOpen)return;const e=document.getElementById("chatMessages");e&&(document.hidden?(e.style.filter="blur(20px)",e.style.transition="filter 0.1s ease"):setTimeout(()=>{e.style.filter="",e.style.transition="filter 0.3s ease"},300))},document.addEventListener("visibilitychange",this._onVisibility),this._onWindowBlur=()=>{if(!this.isOpen)return;const e=document.getElementById("chatMessages");e&&(e.style.filter="blur(25px)",e.style.transition="filter 0.05s ease",this._blurredByScreenshot=!0)},this._onWindowFocus=()=>{if(!this.isOpen||!this._blurredByScreenshot)return;const e=document.getElementById("chatMessages");e&&(this.showSecurityWarning(),setTimeout(()=>{e.style.filter="",e.style.transition="filter 0.5s ease",this._blurredByScreenshot=!1},1500))},window.addEventListener("blur",this._onWindowBlur),window.addEventListener("focus",this._onWindowFocus),this._lastHeight=window.innerHeight,this._onResize=()=>{if(!this.isOpen)return;const e=Math.abs(window.innerHeight-this._lastHeight);this._lastHeight=window.innerHeight,e>0&&e<100&&this.blurChat(2e3)},window.addEventListener("resize",this._onResize),this._onContextMenu=e=>{if(!this.isOpen)return;const t=document.getElementById("chatOverlay");return t&&t.contains(e.target)?(e.preventDefault(),this.showSecurityWarning(),!1):void 0},document.addEventListener("contextmenu",this._onContextMenu),this._onTouchStart=null,this._onTouchEnd=null,"ontouchstart"in window){let e=null;this._onTouchStart=t=>{if(!this.isOpen)return;const n=document.getElementById("chatOverlay");n&&n.contains(t.target)&&(e=setTimeout(()=>{t.preventDefault()},500))},this._onTouchEnd=()=>{e&&clearTimeout(e)},document.addEventListener("touchstart",this._onTouchStart,{passive:!1}),document.addEventListener("touchend",this._onTouchEnd),document.addEventListener("touchmove",this._onTouchEnd)}}removeScreenshotProtection(){this._onKeyDown&&document.removeEventListener("keydown",this._onKeyDown,!0),this._onVisibility&&document.removeEventListener("visibilitychange",this._onVisibility),this._onContextMenu&&document.removeEventListener("contextmenu",this._onContextMenu),this._onWindowBlur&&window.removeEventListener("blur",this._onWindowBlur),this._onWindowFocus&&window.removeEventListener("focus",this._onWindowFocus),this._onResize&&window.removeEventListener("resize",this._onResize),this._onTouchStart&&(document.removeEventListener("touchstart",this._onTouchStart),document.removeEventListener("touchend",this._onTouchEnd),document.removeEventListener("touchmove",this._onTouchEnd)),this.screenshotProtectionActive=!1}blurChat(e){const t=document.getElementById("chatMessages");t&&(t.style.filter="blur(30px)",t.style.transition="filter 0.1s ease",setTimeout(()=>{t.style.filter="",t.style.transition="filter 0.5s ease"},e))}showSecurityWarning(){const e=document.querySelector(".chat-security-warning");e&&e.remove();const t=document.createElement("div");t.className="chat-security-warning",t.innerHTML='\n            <div style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: rgba(0,0,0,0.95);\n                border: 2px solid #e8b4b8;\n                border-radius: 16px;\n                padding: 2rem 3rem;\n                z-index: 100001;\n                text-align: center;\n                animation: secWarningPulse 0.5s ease;\n                backdrop-filter: blur(10px);\n            ">\n                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ”’</div>\n                <div style="\n                    font-family: \'Playfair Display\', serif;\n                    color: #e8b4b8;\n                    font-size: 1.1rem;\n                    font-weight: 600;\n                    letter-spacing: 2px;\n                    margin-bottom: 0.5rem;\n                ">SCREENSHOT BLOCKED</div>\n                <div style="\n                    color: #888;\n                    font-size: 0.8rem;\n                    font-family: \'Montserrat\', sans-serif;\n                ">This chat is protected by end-to-end encryption</div>\n            </div>\n        ',document.body.appendChild(t),setTimeout(()=>t.remove(),2500)}generateUsername(){const e=Math.floor(1e3+9e3*Math.random());this.username=`Titan #${e}`}createChatUI(){if(!document.getElementById("chatSecurityCSS")){const e=document.createElement("style");e.id="chatSecurityCSS",e.textContent="\n                /* Screenshot Protection */\n                .chat-messages {\n                    -webkit-user-select: none !important;\n                    -moz-user-select: none !important;\n                    -ms-user-select: none !important;\n                    user-select: none !important;\n                    -webkit-touch-callout: none !important;\n                }\n                .chat-messages * {\n                    -webkit-user-select: none !important;\n                    user-select: none !important;\n                }\n                .chat-input {\n                    -webkit-user-select: text !important;\n                    user-select: text !important;\n                }\n                /* Invisible watermark layer */\n                .chat-watermark {\n                    position: absolute;\n                    top: 0; left: 0; right: 0; bottom: 0;\n                    pointer-events: none;\n                    z-index: 10;\n                    opacity: 0.015;\n                    overflow: hidden;\n                    font-size: 9px;\n                    color: #e8b4b8;\n                    line-height: 2;\n                    letter-spacing: 8px;\n                    transform: rotate(-25deg);\n                    word-break: break-all;\n                }\n                /* Encryption badge */\n                .chat-encryption-badge {\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    gap: 6px;\n                    padding: 4px 0;\n                    background: rgba(232, 180, 184, 0.06);\n                    border-bottom: 1px solid rgba(232, 180, 184, 0.1);\n                    font-family: 'Montserrat', sans-serif;\n                    font-size: 0.65rem;\n                    color: rgba(232, 180, 184, 0.6);\n                    letter-spacing: 1.5px;\n                    text-transform: uppercase;\n                }\n                .chat-encryption-badge svg {\n                    width: 11px;\n                    height: 11px;\n                    fill: rgba(232, 180, 184, 0.5);\n                }\n                /* Security warning animation */\n                @keyframes secWarningPulse {\n                    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }\n                    50% { transform: translate(-50%, -50%) scale(1.05); }\n                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }\n                }\n                /* Anti-screenshot: make content harder to capture on some devices */\n                .chat-overlay.show .chat-messages {\n                    -webkit-print-color-adjust: exact;\n                    print-color-adjust: exact;\n                }\n                @media print {\n                    .chat-overlay { display: none !important; }\n                }\n                /* Content warning animation */\n                @keyframes warningFadeIn {\n                    from { opacity: 0; transform: translateY(8px); }\n                    to { opacity: 1; transform: translateY(0); }\n                }\n                @keyframes inputShake {\n                    0%, 100% { transform: translateX(0); }\n                    15% { transform: translateX(-6px); }\n                    30% { transform: translateX(5px); }\n                    45% { transform: translateX(-4px); }\n                    60% { transform: translateX(3px); }\n                    75% { transform: translateX(-2px); }\n                }\n                /* Sound toggle button */\n                .chat-sound-toggle {\n                    background: none;\n                    border: 1px solid rgba(232, 180, 184, 0.2);\n                    border-radius: 50%;\n                    width: 32px;\n                    height: 32px;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    cursor: pointer;\n                    font-size: 0.85rem;\n                    transition: all 0.3s ease;\n                    padding: 0;\n                }\n                .chat-sound-toggle:hover {\n                    background: rgba(232, 180, 184, 0.1);\n                    border-color: rgba(232, 180, 184, 0.4);\n                }\n            ",document.head.appendChild(e)}const e=this.userEmail?Array(200).fill(this.userEmail).join(" Â· "):"",t=`\n            <div class="chat-overlay" id="chatOverlay">\n                <div class="chat-container">\n                    <div class="chat-header">\n                        <div>\n                            <div class="chat-title">THE INNER CIRCLE</div>\n                            <div class="chat-subtitle">TITANS ONLY</div>\n                        </div>\n                        <div style="display: flex; align-items: center; gap: 1rem;">\n                            <div class="chat-online-count">\n                                <div class="chat-online-dot"></div>\n                                <span id="onlineCount">1</span> Online\n                            </div>\n                            <button class="chat-sound-toggle" id="chatSoundToggle" title="${this.soundEnabled?"Sound deaktivieren":"Sound aktivieren"}">\n                                ${this.soundEnabled?"ðŸ””":"ðŸ”‡"}\n                            </button>\n                            <button class="chat-close" id="chatCloseBtn">Ã—</button>\n                        </div>\n                    </div>\n                    \n                    <div class="chat-encryption-badge">\n                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n                            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/>\n                        </svg>\n                        End-to-End Encrypted Â· Screenshot Protected\n                    </div>\n                    \n                    <div class="chat-messages" id="chatMessages" style="position: relative;">\n                        <div class="chat-watermark" id="chatWatermark">${e}</div>\n                        <div class="chat-empty">\n                            <div class="chat-empty-icon">ðŸ’¬</div>\n                            <div class="chat-empty-text">Welcome, ${this.username}</div>\n                            <div class="chat-empty-subtext">You've unlocked The Inner Circle.<br>Share wisdom with fellow Titans.</div>\n                        </div>\n                    </div>\n                    \n                    <div class="chat-input-container">\n                        <input \n                            type="file" \n                            id="chatFileInput" \n                            accept="image/*,.pdf,.doc,.docx,.txt"\n                            style="display: none;"\n                        />\n                        <button class="chat-attach-btn" id="chatAttachBtn" title="Bild oder Datei anhÃ¤ngen">\n                            ðŸ“Ž\n                        </button>\n                        <input \n                            type="text" \n                            class="chat-input" \n                            id="chatInput" \n                            placeholder="Share your thoughts..."\n                            maxlength="500"\n                        />\n                        <button class="chat-send-btn" id="chatSendBtn">\n                            âž¤\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",t),document.getElementById("chatCloseBtn").addEventListener("click",()=>{this.close()}),document.getElementById("chatSoundToggle").addEventListener("click",()=>{this.toggleSound()}),document.getElementById("chatAttachBtn").addEventListener("click",()=>{document.getElementById("chatFileInput").click()}),document.getElementById("chatFileInput").addEventListener("change",e=>{this.handleFileUpload(e.target.files[0])});const n=document.getElementById("chatMessages"),s=document.getElementById("chatInput");["dragenter","dragover","dragleave","drop"].forEach(e=>{n.addEventListener(e,e=>{e.preventDefault(),e.stopPropagation()}),s.addEventListener(e,e=>{e.preventDefault(),e.stopPropagation()})}),["dragenter","dragover"].forEach(e=>{n.addEventListener(e,()=>{n.style.background="rgba(232, 196, 168, 0.05)"}),s.addEventListener(e,()=>{s.style.background="rgba(232, 196, 168, 0.08)"})}),["dragleave","drop"].forEach(e=>{n.addEventListener(e,()=>{n.style.background=""}),s.addEventListener(e,()=>{s.style.background=""})});const i=e=>{const t=e.dataTransfer.files;t.length>0&&this.handleFileUpload(t[0])};n.addEventListener("drop",i),s.addEventListener("drop",i),document.getElementById("chatSendBtn").addEventListener("click",()=>{this.sendMessage()}),document.getElementById("chatInput").addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})}open(){const e=document.querySelector(".easter-egg-container");if(!e)return;e.style.pointerEvents="none";const t=e.querySelector(".eye");if(t){const n=t.cloneNode(!0),s=e.getBoundingClientRect();n.style.position="fixed",n.style.top=s.top+"px",n.style.left=s.left+"px",n.style.width="80px",n.style.height="80px",n.style.zIndex="9998",n.classList.add("eye-closing"),document.body.appendChild(n),e.style.opacity="0",this.particleInterval=setInterval(()=>{const e=document.createElement("div");e.className="eye-particles";const t=n.getBoundingClientRect();e.style.top=t.top+40+"px",e.style.left=t.left+40+"px",document.body.appendChild(e),setTimeout(()=>e.remove(),1500)},80),setTimeout(()=>{n.classList.add("traveling"),this.particleInterval&&(clearInterval(this.particleInterval),this.particleInterval=null)},2e3),setTimeout(()=>n.remove(),4600)}setTimeout(()=>{const e=document.createElement("div");e.className="eye-center-aura",document.body.appendChild(e);const t=document.createElement("div");t.className="eye-center",t.innerHTML='<img src="assets/images/eye-simple.svg" style="width: 100%; height: 100%;">',document.body.appendChild(t),setTimeout(()=>{e.remove(),t.remove()},5e3)},4600),setTimeout(()=>{const e=document.createElement("div");e.className="light-explosion",document.body.appendChild(e),setTimeout(()=>e.remove(),2e3)},9300),setTimeout(()=>{document.getElementById("chatOverlay").classList.add("show"),this.isOpen=!0,this._audioCtx&&"suspended"===this._audioCtx.state&&this._audioCtx.resume(),this.markChatSession(),this.loadMessages(),this.scrollToBottom()},9500)}async markChatSession(){try{await fetch("/api/easter-egg",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:this.userEmail,action:"mark_chat_session"})})}catch(e){console.error("Error marking chat session:",e)}}close(){document.getElementById("chatOverlay").classList.remove("show"),this.isOpen=!1;const e=document.getElementById("chatMessages");e&&(e.style.filter=""),this._blurredByScreenshot=!1;const t=document.querySelector(".easter-egg-container");t&&(t.style.opacity="1",t.style.pointerEvents="auto")}checkForPersonalInfo(e){if(!e)return null;e.toLowerCase().replace(/\s+/g," ");return/[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/i.test(e)?"email address":/(?:\+?\d{1,4}[\s\-.]?)?(?:\(?\d{2,5}\)?[\s\-.]?)?\d{3,}[\s\-.]?\d{2,}/g.test(e)&&e.replace(/[^\d]/g,"").length>=7?"phone number":/(?:instagram\.com\/|@[a-zA-Z0-9._]{3,}|\b(?:insta|ig)\s*[:=]|\bmein\s*(?:insta|ig)\b|\bmy\s*(?:insta|ig)\b|\bfollow\s*(?:me|mich)\b)/i.test(e)?"Instagram":/(?:twitter\.com\/|x\.com\/[a-zA-Z0-9_]|\btwitter\s*[:=]|\bmein\s*twitter\b|\bmy\s*twitter\b)/i.test(e)?"Twitter/X":/(?:snapchat\.com\/|\bsnapchat\s*[:=]|\bsnap\s*[:=]|\bmein\s*snap(?:chat)?\b|\bmy\s*snap(?:chat)?\b|\badd\s*(?:me|mich)\s*(?:on|auf)\s*snap)/i.test(e)?"Snapchat":/(?:tiktok\.com\/@|\btiktok\s*[:=]|\bmein\s*tiktok\b|\bmy\s*tiktok\b)/i.test(e)?"TikTok":/(?:wa\.me\/|\bwhatsapp\s*[:=]|\btelegram\s*[:=]|\bsignal\s*[:=]|\bschreib\s*(?:mir|mich)\s*(?:auf|per|Ã¼ber)\s*(?:whatsapp|telegram|signal)|\bmessage\s*me\s*on\s*(?:whatsapp|telegram|signal))/i.test(e)?"WhatsApp/Telegram":/(?:discord\.gg\/|\bdiscord\s*[:=]|\bmein\s*discord\b|\bmy\s*discord\b)/i.test(e)?"Discord":/(?:facebook\.com\/|fb\.com\/|linkedin\.com\/in\/|\bfacebook\s*[:=]|\blinkedin\s*[:=])/i.test(e)?"Facebook/LinkedIn":/(?:youtube\.com\/(?:c\/|channel\/|@)|youtu\.be\/|\byoutube\s*[:=]|\bmein\s*(?:youtube|kanal)\b|\bmy\s*(?:youtube|channel)\b)/i.test(e)?"YouTube":/(?:https?:\/\/|www\.)[a-zA-Z0-9\-]+\.[a-zA-Z]{2,}/i.test(e)?"link/URL":/(?:\b\d{4,5}\s+[A-ZÃ„Ã–Ãœ][a-zÃ¤Ã¶Ã¼ÃŸ]+|\b[\wÃ¤Ã¶Ã¼ÃŸ]+(?:straÃŸe|strasse|str\.|gasse|weg|allee|platz|ring|damm)\s+\d|\b\d+\s+(?:street|road|avenue|drive|lane|blvd)\b)/i.test(e)?"address":null}showContentWarning(e){const t=document.getElementById("chatMessages");if(!t)return;const n=t.querySelector(".chat-content-warning");n&&n.remove();const s=document.createElement("div");s.className="chat-content-warning",s.innerHTML=`\n            <div style="\n                background: rgba(255, 70, 70, 0.08);\n                border: 1px solid rgba(255, 70, 70, 0.3);\n                border-radius: 12px;\n                padding: 1rem 1.2rem;\n                margin: 0.8rem 1rem;\n                text-align: center;\n                animation: warningFadeIn 0.3s ease;\n            ">\n                <div style="\n                    font-family: 'Playfair Display', serif;\n                    color: #ff6b6b;\n                    font-size: 0.95rem;\n                    font-weight: 600;\n                    letter-spacing: 1.5px;\n                    margin-bottom: 0.4rem;\n                ">WARNING</div>\n                <div style="\n                    color: rgba(255, 150, 150, 0.9);\n                    font-size: 0.78rem;\n                    font-family: 'Montserrat', sans-serif;\n                    line-height: 1.5;\n                ">Sharing personal information (${this.escapeHtml(e)}) is not allowed in The Inner Circle.<br>\n                This includes social media, emails, phone numbers, and addresses.<br>\n                <span style="color: #e8b4b8; font-weight: 500;">Your anonymity protects you.</span></div>\n            </div>\n        `,t.appendChild(s),this.scrollToBottom(),setTimeout(()=>{s.parentNode&&(s.style.transition="opacity 0.5s ease",s.style.opacity="0",setTimeout(()=>s.remove(),500))},8e3)}async sendMessage(e=null,t=null,n=null){const s=document.getElementById("chatInput"),i=s.value.trim();if(i||e){if(i){const e=this.checkForPersonalInfo(i);if(e)return this.showContentWarning(e),s.style.animation="none",s.offsetHeight,void(s.style.animation="inputShake 0.5s ease")}try{const a={username:this.username,message:i||""};e&&(a.fileUrl=e,a.fileName=t,a.fileType=n);const o=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(a)});if(o.ok){const e=await o.json();if(e.blocked)return void this.showContentWarning(e.blockedType||"personal information");s.value="",await this.loadMessages(),this.scrollToBottom()}}catch(e){console.error("Error sending message:",e)}}}async handleFileUpload(e){if(!e)return;const t=document.getElementById("chatInput"),n=t.placeholder;t.placeholder="Uploading file...",t.disabled=!0;try{const t=new FormData;t.append("file",e);const n=await fetch("/api/upload-file",{method:"POST",body:t});if(n.ok){const t=await n.json(),s=e.type.startsWith("image/")?"image":"file";await this.sendMessage(t.secure_url,e.name,s)}else{const e=await n.json().catch(()=>({}));console.error("Upload error:",e),window.toast.error(`Upload failed: ${e.error||"Unknown error"}`,{title:"Upload Error"})}}catch(e){console.error("Error uploading file:",e),window.toast.error("Upload error. Please try again.",{title:"Upload Failed"})}finally{t.placeholder=n,t.disabled=!1,document.getElementById("chatFileInput").value=""}}async loadMessages(){try{const e=this.sessionStart?`&since=${encodeURIComponent(this.sessionStart)}`:"",t=await fetch(`/api/chat?${e.replace(/^&/,"")}`,{credentials:"include"}),n=await t.json();if(n.messages){const e=n.messages.length;if(!this.isOpen&&this.lastMessageCount>0&&e>this.lastMessageCount&&(this.triggerEyeBlink(),this.playNotificationSound(),window.notificationManager&&n.messages.length>0)){const e=n.messages[n.messages.length-1];window.notificationManager.notifyNewChatMessage(e.username)}const t=e>this.lastMessageCount;if(this.isOpen&&t&&this.lastMessageCount>0){const e=n.messages[n.messages.length-1];e&&e.username!==this.username&&this.playNotificationSound()}this.lastMessageCount=e,this.messages=n.messages,this.renderMessages(),this.isOpen&&t&&this.scrollToBottom()}n.onlineCount&&(document.getElementById("onlineCount").textContent=n.onlineCount)}catch(e){console.error("Error loading messages:",e)}}triggerEyeBlink(){const e=document.querySelector(".easter-egg-container .eye");e&&(e.classList.add("eye-blink-notification"),setTimeout(()=>{e.classList.remove("eye-blink-notification")},1e3))}renderMessages(){const e=document.getElementById("chatMessages");if(0===this.messages.length)return;const t=e.querySelector(".chat-empty");t&&t.remove();const n=new Set(Array.from(e.querySelectorAll(".message")).map(e=>e.dataset.messageId));this.messages.forEach((t,s)=>{const i=`${t.created_at}_${t.username}_${s}`;if(n.has(i))return;const a=t.username===this.username,o=document.createElement("div");o.className="message "+(a?"own":"other"),o.dataset.messageId=i;const r=new Date(t.created_at).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});let l="";if(t.file_url){const e=this.escapeHtml(t.file_url);"image"===t.file_type?l+=`\n                        <div class="message-image">\n                            <img src="${e}" alt="${this.escapeHtml(t.file_name)}" \n                                 onclick="window.open('${e}', '_blank')"\n                                 style="max-width: 300px; max-height: 300px; border-radius: 8px; cursor: pointer;">\n                        </div>\n                    `:l+=`\n                        <div class="message-file">\n                            <a href="${e}" target="_blank" class="file-link">\n                                ðŸ“„ ${this.escapeHtml(t.file_name)}\n                            </a>\n                        </div>\n                    `}t.message&&(l+=`<div class="message-bubble">${this.escapeHtml(t.message)}</div>`),o.innerHTML=`\n                <div class="message-header">${this.escapeHtml(t.username)}</div>\n                ${l}\n                <div class="message-time">${r}</div>\n            `,e.appendChild(o)})}scrollToBottom(){const e=document.getElementById("chatMessages");setTimeout(()=>{e.scrollTop=e.scrollHeight},100)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}startPolling(){this.pollingInterval&&clearInterval(this.pollingInterval),this.loadMessages(),this.pollingInterval=setInterval(()=>{this.loadMessages()},3e3)}}let luxuryChat=null;"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",()=>{});