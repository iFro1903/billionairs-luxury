class StripePaymentProcessor{constructor(){this.stripe=Stripe("pk_live_51SJwwF7Fzwybk1NyPjyrV9qkZvmWDkCqsdrmotHypJZnhEIUtnxBea6tV9MMOVkllj9po7RtSIcSwY8JEDQcTPGB00BqlA7hkz"),this.priceId="price_1SL9Be7Fzwybk1NyQpd06DhZ",this.isProcessing=!1,this.paymentTiers={full:5e7,split:5e7,corporate:5e7}}async createCheckoutSession(e="full",n=null){if(!this.isProcessing){this.isProcessing=!0;try{this.showPaymentLoading();const t=this.paymentTiers[e],r={product:"BILLIONAIRS_EXCLUSIVE_ACCESS",tier:"MILLIONAIRE_SEGMENT",payment_type:e,timestamp:(new Date).toISOString(),user_agent:navigator.userAgent,referrer:document.referrer||"direct",language:localStorage.getItem("billionairs_lang")||"en"};n&&(r.customer_name=n.fullName,r.customer_email=n.email,r.customer_phone=n.phone,n.company&&(r.customer_company=n.company));const o=localStorage.getItem("billionairs_lang")||"en",s=await fetch("/api/stripe-checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({priceId:this.priceId,mode:"payment",currency:"chf",amount:t,paymentType:e,customerData:n,metadata:r,language:o})});if(!s.ok){const e=await s.text();throw console.error("❌ Server error:",e),new Error(`Server error: ${s.status} - ${e}`)}const a=await s.json();if(a.error)throw console.error("❌ Session error:",a.error),new Error(a.error);if(!a.url)throw console.error("❌ No session URL:",a),new Error("No checkout URL received from server");sessionStorage.setItem("paymentInitiated","true"),window.location.href=a.url}catch(e){console.error("Payment Error:",e),this.showPaymentError(e.message)}finally{this.isProcessing=!1}}}async createWireTransferRequest(){if(!ENABLE_BANK_TRANSFER)return void window.toast.info("Bank wire transfer is temporarily unavailable. Please use Credit Card or Cryptocurrency.",{title:"Temporarily Unavailable"});if(this.isProcessing)return;const e=document.getElementById("customerName"),n=document.getElementById("customerEmail"),t=document.getElementById("customerPassword"),r=document.getElementById("customerPasswordConfirm"),o=document.getElementById("customerPhone"),s=document.getElementById("customerCompany");if(!(e&&n&&t&&r&&o))return void this.showPaymentError("Please fill in all required fields");const a=e.value.trim(),i=n.value.trim(),l=t.value,c=r.value,m=o.value.trim(),d=s?s.value.trim():"";if(!(a&&i&&l&&c&&m))return void this.showPaymentError("Please fill in all required fields");if(l!==c)return void this.showPaymentError("Passwords do not match");if(l.length<8)return void this.showPaymentError("Password must be at least 8 characters");if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i)){this.isProcessing=!0;try{this.showPaymentLoading();const e=await fetch("/api/wire-transfer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fullName:a,email:i,password:l,phone:m,company:d})});if(!e.ok){const n=await e.json();throw console.error("❌ Wire Transfer error:",n),new Error(n.error||n.message||"Wire transfer request failed")}const n=await e.json();this.showBankDetailsModal(n.bankDetails,n.instructions)}catch(e){console.error("Wire Transfer Error:",e),this.showPaymentError(e.message)}finally{this.isProcessing=!1}}else this.showPaymentError("Please enter a valid email address")}escapeHtml(e){if(null==e)return"";const n=document.createElement("div");return n.textContent=String(e),n.innerHTML}showBankDetailsModal(e,n){const t=this.escapeHtml(e.amount),r=this.escapeHtml(e.bankName),o=this.escapeHtml(e.accountHolder),s=this.escapeHtml(e.iban),a=this.escapeHtml(e.swift),i=this.escapeHtml(e.reference),l=this.escapeHtml(e.address),c=n.map(e=>this.escapeHtml(e)),m=document.createElement("div");m.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.95);\n            z-index: 10000;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 2rem;\n        ",m.innerHTML=`\n            <div style="\n                background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);\n                padding: 3rem;\n                border-radius: 16px;\n                max-width: 600px;\n                width: 100%;\n                border: 1px solid rgba(232, 180, 160, 0.3);\n                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);\n            ">\n                <h2 style="\n                    font-family: 'Playfair Display', serif;\n                    font-size: 2rem;\n                    color: #E8B4A0;\n                    margin-bottom: 1rem;\n                    text-align: center;\n                ">Bank Wire Transfer Details</h2>\n                \n                <p style="\n                    color: rgba(255, 255, 255, 0.7);\n                    text-align: center;\n                    margin-bottom: 2rem;\n                    font-size: 0.9rem;\n                ">Please use the following details to complete your wire transfer</p>\n\n                <div style="\n                    background: rgba(232, 180, 160, 0.05);\n                    border-left: 3px solid #E8B4A0;\n                    padding: 1.5rem;\n                    border-radius: 8px;\n                    margin-bottom: 1.5rem;\n                ">\n                    <div style="margin-bottom: 1rem;">\n                        <strong style="color: #E8B4A0;">Amount:</strong>\n                        <span style="color: #ffffff; font-size: 1.2rem; margin-left: 1rem;">${t}</span>\n                    </div>\n                    <div style="margin-bottom: 1rem;">\n                        <strong style="color: #E8B4A0;">Bank Name:</strong>\n                        <span style="color: rgba(255, 255, 255, 0.9); margin-left: 1rem;">${r}</span>\n                    </div>\n                    <div style="margin-bottom: 1rem;">\n                        <strong style="color: #E8B4A0;">Account Holder:</strong>\n                        <span style="color: rgba(255, 255, 255, 0.9); margin-left: 1rem;">${o}</span>\n                    </div>\n                    <div style="margin-bottom: 1rem;">\n                        <strong style="color: #E8B4A0;">IBAN:</strong>\n                        <span style="color: rgba(255, 255, 255, 0.9); margin-left: 1rem; font-family: monospace;">${s}</span>\n                    </div>\n                    <div style="margin-bottom: 1rem;">\n                        <strong style="color: #E8B4A0;">SWIFT/BIC:</strong>\n                        <span style="color: rgba(255, 255, 255, 0.9); margin-left: 1rem; font-family: monospace;">${a}</span>\n                    </div>\n                    <div style="margin-bottom: 1rem;">\n                        <strong style="color: #E8B4A0;">Reference:</strong>\n                        <span style="color: #FF6B6B; margin-left: 1rem; font-weight: 700; font-family: monospace;">${i}</span>\n                    </div>\n                    <div style="margin-bottom: 0;">\n                        <strong style="color: #E8B4A0;">Bank Address:</strong>\n                        <span style="color: rgba(255, 255, 255, 0.9); margin-left: 1rem; font-size: 0.85rem;">${l}</span>\n                    </div>\n                </div>\n\n                <div style="\n                    background: rgba(255, 107, 107, 0.1);\n                    border-left: 3px solid #FF6B6B;\n                    padding: 1rem;\n                    border-radius: 8px;\n                    margin-bottom: 2rem;\n                ">\n                    <strong style="color: #FF6B6B; display: block; margin-bottom: 0.5rem;">⚠️ Important:</strong>\n                    ${c.map(e=>`\n                        <p style="color: rgba(255, 255, 255, 0.8); margin: 0.5rem 0; font-size: 0.85rem;">• ${e}</p>\n                    `).join("")}\n                </div>\n\n                <button onclick="\n                    sessionStorage.setItem('paymentInitiated', 'true');\n                    const currentLang = localStorage.getItem('billionairs_lang') || 'en';\n                    window.location.href = '/login.html?message=Payment initiated! Your account has been created. Please login.&lang=' + currentLang;\n                " style="\n                    width: 100%;\n                    padding: 1rem;\n                    background: #E8B4A0;\n                    color: #000000;\n                    border: none;\n                    border-radius: 8px;\n                    font-weight: 700;\n                    font-size: 0.9rem;\n                    letter-spacing: 2px;\n                    cursor: pointer;\n                    transition: all 0.3s ease;\n                " onmouseover="this.style.background='#F5D4C1'" onmouseout="this.style.background='#E8B4A0'">\n                    I HAVE NOTED THE DETAILS\n                </button>\n\n                <p style="\n                    text-align: center;\n                    color: rgba(255, 255, 255, 0.5);\n                    font-size: 0.75rem;\n                    margin-top: 1rem;\n                ">These details have also been sent to your email address</p>\n            </div>\n        `,document.body.appendChild(m);const d=document.querySelector(".payment-button");d&&(d.innerHTML='<span class="button-text">SECURE PAYMENT</span>',d.disabled=!1,d.style.opacity="1")}showPaymentLoading(){const e=document.querySelector(".payment-button");e&&(e.innerHTML='\n                <div class="loading-spinner"></div>\n                PROCESSING SECURE PAYMENT...\n            ',e.disabled=!0,e.style.opacity="0.7")}showPaymentError(e){const n=document.querySelector(".payment-button");n&&(n.innerHTML="PAYMENT ERROR - TRY AGAIN",n.disabled=!1,n.style.opacity="1",n.classList.add("error-state"),setTimeout(()=>{n.innerHTML='<span class="button-text">SECURE PAYMENT</span>',n.classList.remove("error-state")},3e3)),this.showErrorModal(e)}showErrorModal(e){const n=document.createElement("div");n.className="payment-error-modal",n.innerHTML=`\n            <div class="error-content">\n                <div class="error-icon">⚠️</div>\n                <h3>Payment Processing Error</h3>\n                <p>We encountered an issue processing your payment:</p>\n                <p class="error-details">${this.escapeHtml(e)}</p>\n                <p>Please try again or contact our support team.</p>\n                <button class="error-close-btn" onclick="this.parentElement.parentElement.remove()">\n                    CLOSE\n                </button>\n            </div>\n        `,document.body.appendChild(n),setTimeout(()=>{n.parentElement&&n.remove()},1e4)}handlePaymentSuccess(e){"undefined"!=typeof gtag&&gtag("event","purchase",{transaction_id:e,value:5e5,currency:"CHF",items:[{item_id:"billionairs_access",item_name:"BILLIONAIRS Exclusive Access",category:"Digital Experience",quantity:1,price:5e5}]}),this.showPaymentSuccess()}async createCryptoPaymentRequest(e){if(this.isProcessing)return;const n=document.getElementById("customerName"),t=document.getElementById("customerEmail"),r=document.getElementById("customerPhone"),o=document.getElementById("customerCompany"),s=n?.value?.trim(),a=t?.value?.trim(),i=r?.value?.trim(),l=o?.value?.trim();if(!s||!a||!i)return console.error("❌ Validation failed:",{fullName:s,email:a,phone:i}),void window.toast.warning("Please fill in all required fields (Name, Email, Phone)",{title:"Missing Fields"});/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)?await this.createCryptoPaymentRequestWithData(e,{fullName:s,email:a,phone:i,company:l}):window.toast.warning("Please enter a valid email address",{title:"Invalid Email"})}async createCryptoPaymentRequestWithData(e,n){if(this.isProcessing)return;const{fullName:t,email:r,password:o,phone:s,company:a}=n;this.isProcessing=!0;try{const n=await fetch("/api/crypto-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fullName:t,email:r,password:o,phone:s,company:a,cryptocurrency:e})});if(!n.ok){const e=await n.json();throw new Error(e.error||"Failed to create crypto payment request")}const i=await n.json();this.showCryptoWalletModal(i)}catch(e){console.error("Crypto payment error:",e),window.toast.error("Failed to create crypto payment request. Please try again.",{title:"Payment Error"})}finally{this.isProcessing=!1}}showCryptoWalletModal(e){const n=document.createElement("div");n.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.95);\n            z-index: 10000;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 2rem;\n            overflow-y: auto;\n        ",n.innerHTML=`\n            <div style="\n                background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n                border: 2px solid #E8B4A0;\n                border-radius: 12px;\n                padding: 3rem;\n                max-width: 600px;\n                width: 100%;\n                position: relative;\n                box-shadow: 0 20px 60px rgba(232, 180, 160, 0.3);\n            ">\n                <h2 style="\n                    font-family: 'Playfair Display', serif;\n                    font-size: 2rem;\n                    color: #E8B4A0;\n                    text-align: center;\n                    margin-bottom: 0.5rem;\n                    font-weight: 700;\n                ">${this.escapeHtml(e.wallet.symbol)} ${this.escapeHtml(e.cryptocurrency)} Payment</h2>\n                \n                <p style="\n                    text-align: center;\n                    color: rgba(255, 255, 255, 0.7);\n                    font-size: 0.9rem;\n                    margin-bottom: 2rem;\n                ">CHF 500'000.00</p>\n\n                <div style="\n                    text-align: center;\n                    margin: 2rem 0;\n                    padding: 2rem;\n                    background: rgba(255, 255, 255, 0.95);\n                    border-radius: 12px;\n                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);\n                ">\n                    <img src="${e.wallet.qrCode}" alt="QR Code" style="\n                        width: 300px;\n                        height: 300px;\n                        border: 4px solid #E8B4A0;\n                        border-radius: 12px;\n                        display: block;\n                        margin: 0 auto;\n                    " onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">\n                    <div style="display: none; color: #FF6B6B; padding: 2rem; font-size: 0.9rem;">\n                        ⚠️ QR Code could not be loaded. Please copy the wallet address manually.\n                    </div>\n                </div>\n\n                <div style="\n                    background: rgba(232, 180, 160, 0.1);\n                    border: 2px dashed #E8B4A0;\n                    border-radius: 8px;\n                    padding: 1rem;\n                    margin: 1.5rem 0;\n                    text-align: center;\n                ">\n                    <p style="\n                        color: rgba(255, 255, 255, 0.7);\n                        font-size: 0.75rem;\n                        text-transform: uppercase;\n                        letter-spacing: 1px;\n                        margin-bottom: 0.5rem;\n                    ">Wallet Address</p>\n                    <p style="\n                        color: #E8B4A0;\n                        font-family: 'Courier New', monospace;\n                        font-size: 0.85rem;\n                        font-weight: 700;\n                        word-break: break-all;\n                        letter-spacing: 0.5px;\n                    ">${this.escapeHtml(e.wallet.address)}</p>\n                </div>\n\n                <div style="\n                    background: rgba(0, 0, 0, 0.3);\n                    border-radius: 8px;\n                    padding: 1.5rem;\n                    margin: 1.5rem 0;\n                ">\n                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(232, 180, 160, 0.2);">\n                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">Network</span>\n                        <span style="color: #ffffff; font-weight: 600; font-size: 0.85rem;">${this.escapeHtml(e.wallet.network)}</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(232, 180, 160, 0.2);">\n                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">Amount (CHF)</span>\n                        <span style="color: #E8B4A0; font-weight: 700; font-size: 0.9rem;">${this.escapeHtml(e.amount.chf)}</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0;">\n                        <span style="color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">Reference</span>\n                        <span style="color: #ffffff; font-weight: 600; font-size: 0.85rem;">${this.escapeHtml(e.reference)}</span>\n                    </div>\n                </div>\n\n                <div style="\n                    background: rgba(255, 59, 48, 0.1);\n                    border-left: 4px solid #FF3B30;\n                    padding: 1rem;\n                    margin: 1.5rem 0;\n                    border-radius: 4px;\n                ">\n                    <p style="color: #FF3B30; font-weight: 700; font-size: 0.85rem; margin-bottom: 0.5rem;">⚠️ IMPORTANT</p>\n                    <ul style="color: rgba(255, 255, 255, 0.8); font-size: 0.8rem; line-height: 1.6; margin: 0; padding-left: 1.5rem;">\n                        <li>Double-check the wallet address</li>\n                        <li>Only use ${this.escapeHtml(e.wallet.network)} network</li>\n                        <li>Transactions are irreversible</li>\n                        <li>Email us the transaction hash</li>\n                    </ul>\n                </div>\n\n                <button onclick="\n                    // Mark payment as initiated\n                    sessionStorage.setItem('paymentInitiated', 'true');\n                    // Reset processing flag\n                    if (window.stripeProcessor) {\n                        window.stripeProcessor.isProcessing = false;\n                    }\n                    // Redirect to login page\n                    const currentLang = localStorage.getItem('billionairs_lang') || 'en';\n                    window.location.href = '/login.html?message=Payment initiated! Your account has been created. Please login.&lang=' + currentLang;\n                " style="\n                    width: 100%;\n                    padding: 1rem 2rem;\n                    background: linear-gradient(135deg, #E8B4A0 0%, #D4A574 100%);\n                    color: rgba(0,0,0,0.9);\n                    border: none;\n                    border-radius: 6px;\n                    font-weight: 700;\n                    font-size: 0.9rem;\n                    letter-spacing: 2px;\n                    cursor: pointer;\n                    transition: all 0.3s ease;\n                    margin-top: 1rem;\n                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(232, 180, 160, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">\n                    I HAVE NOTED THE DETAILS\n                </button>\n\n                <p style="\n                    text-align: center;\n                    color: rgba(255, 255, 255, 0.5);\n                    font-size: 0.75rem;\n                    margin-top: 1rem;\n                ">These details have also been sent to your email address</p>\n            </div>\n        `,document.body.appendChild(n)}showPaymentSuccess(){const e=document.createElement("div");e.className="payment-success-overlay",e.innerHTML='\n            <div class="success-content">\n                <div class="success-icon" style="width:60px;height:60px;border-radius:50%;border:2px solid #c9a96e;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;font-size:1.5rem;color:#c9a96e;">&#10003;</div>\n                <h2>PAYMENT SUCCESSFUL</h2>\n                <p>Welcome to BILLIONAIRS</p>\n                <p>Your exclusive access has been activated.</p>\n                <div class="success-divider"></div>\n                <p class="success-note">Creating your INNER CIRCLE account...</p>\n            </div>\n        ',document.body.appendChild(e),setTimeout(()=>{const e=localStorage.getItem("billionairs_lang")||"en";window.location.href="/login.html?message=Account created! Please login with your credentials.&lang="+e},3e3)}}function initStripeProcessor(){if("undefined"!=typeof Stripe)try{const e=new StripePaymentProcessor;window.stripeProcessor=e}catch(e){console.error("❌ Stripe processor init error:",e),setTimeout(initStripeProcessor,1e3)}else setTimeout(initStripeProcessor,500)}initStripeProcessor();